# ××™×¤×™×•×Ÿ ××¤×•×¨×˜ ×œ×‘×•×˜ ×˜×œ×’×¨× ×œ×œ×™××•×“ ×× ×’×œ×™×ª

## 1. ×¡×§×™×¨×” ×›×œ×œ×™×ª

×”×‘×•×˜ ×”××ª×•×›× ×Ÿ ×™×”×™×” ×›×œ×™ ××™× ×˜×¨××§×˜×™×‘×™ ×œ×œ×™××•×“ ×× ×’×œ×™×ª ×‘×˜×œ×’×¨×, ×”××‘×•×¡×¡ ×¢×œ ×××’×¨ ×©×œ ×›-4,300 ××™×œ×™×. ×”×‘×•×˜ ×™×©×œ×‘ ×™×›×•×œ×•×ª LLM ×‘×××¦×¢×•×ª ×”-API ×©×œ Gemini ×•×™×¦×™×¢ ××’×•×•×Ÿ ×¤×¢×™×œ×•×™×•×ª ×œ×™××•×“×™×•×ª ×©×™×¡×™×™×¢×• ×œ××©×ª××©×™× ×œ×©×¤×¨ ××ª ××•×¦×¨ ×”××™×œ×™×, ×”×“×§×“×•×§ ×•×”×©×™××•×© ×‘×©×¤×” ×”×× ×’×œ×™×ª.

## 2. ×¡×™×¤×•×¨×™ ××©×ª××©

### ××©×ª××© ×—×“×©
- **×‘×ª×•×¨** ××©×ª××© ×—×“×©
- **×× ×™ ×¨×•×¦×”** ×œ×”×™×¨×©× ×œ×‘×•×˜ ×‘×§×œ×•×ª
- **×›×“×™** ×œ×”×ª×—×™×œ ×œ×œ××•×“ ×× ×’×œ×™×ª ××™×“

### ××¢×§×‘ ××—×¨ ×”×ª×§×“××•×ª
- **×‘×ª×•×¨** ×œ×•××“ ×§×‘×•×¢
- **×× ×™ ×¨×•×¦×”** ×œ×¨××•×ª ××ª ×”×”×ª×§×“××•×ª ×©×œ×™
- **×›×“×™** ×œ×“×¢×ª ××™×¤×” ×× ×™ ×¢×•××“ ×•××” ×¢×•×“ × ×©××¨ ×œ×™ ×œ×œ××•×“

### ××™××•×Ÿ ×™×•××™
- **×‘×ª×•×¨** ××©×ª××© ××—×•×™×‘
- **×× ×™ ×¨×•×¦×”** ×œ×§×‘×œ ××©×™××” ×™×•××™×ª
- **×›×“×™** ×œ×©××•×¨ ×¢×œ ×¨×¦×£ ×œ×™××•×“×™

### ×ª×¨×’×•×œ ××™×œ×™× ×—×“×©×•×ª
- **×‘×ª×•×¨** ×œ×•××“ ×× ×’×œ×™×ª
- **×× ×™ ×¨×•×¦×”** ×œ×œ××•×“ ××™×œ×™× ×—×“×©×•×ª ×‘×”×§×©×¨×™× ×©×•× ×™×
- **×›×“×™** ×œ×–×›×•×¨ ××•×ª×Ÿ ×˜×•×‘ ×™×•×ª×¨

### ×ª×¨×’×•×œ ×›×ª×™×‘×”
- **×‘×ª×•×¨** ×œ×•××“ ×× ×’×œ×™×ª
- **×× ×™ ×¨×•×¦×”** ×œ×›×ª×•×‘ ×˜×§×¡×˜×™× ×§×¦×¨×™× ×•×œ×§×‘×œ ××©×•×‘
- **×›×“×™** ×œ×©×¤×¨ ××ª ×™×›×•×œ×ª ×”×›×ª×™×‘×” ×©×œ×™

### ××©×—×§×™ ××™×œ×™×
- **×‘×ª×•×¨** ×œ×•××“ ×× ×’×œ×™×ª
- **×× ×™ ×¨×•×¦×”** ×œ×©×—×§ ××©×—×§×™× ××™× ×˜×¨××§×˜×™×‘×™×™×
- **×›×“×™** ×œ×œ××•×“ ×‘×¦×•×¨×” ×›×™×¤×™×ª ×•××¢× ×™×™× ×ª

### ×”×ª×××” ××™×©×™×ª
- **×‘×ª×•×¨** ×œ×•××“ ×¢× ×¦×¨×›×™× ×¡×¤×¦×™×¤×™×™×
- **×× ×™ ×¨×•×¦×”** ×œ×”×ª××™× ××ª ×”×œ×™××•×“ ×œ×ª×—×•××™ ×”×¢× ×™×™×Ÿ ×©×œ×™
- **×›×“×™** ×©×”×œ×™××•×“ ×™×”×™×” ×¨×œ×•×•× ×˜×™ ×¢×‘×•×¨×™

## 3. ××¨×›×™×˜×§×˜×•×¨×” ×˜×›× ×™×ª

### 3.1 ×˜×›× ×•×œ×•×’×™×•×ª ××¨×›×–×™×•×ª

1. **Python** - ×©×¤×ª ×”×ª×›× ×•×ª ×”×¢×™×§×¨×™×ª
2. **python-telegram-bot** - ×¡×¤×¨×™×™×ª Python ×œ×¢×‘×•×“×” ×¢× Telegram Bot API
3. **Google Gemini API** - ×©×™×¨×•×ª ×”-LLM ×œ×©×™×œ×•×‘ ×™×›×•×œ×•×ª AI
4. **MongoDB** - ××¡×“ × ×ª×•× ×™× ×œ×©××™×¨×ª × ×ª×•× ×™ ××©×ª××©×™× ×•×”×ª×§×“××•×ª
5. **Redis** - ×œ× ×™×”×•×œ ××¦×‘×™ ×©×™×—×” (session states) ×•×§××©×™× ×’
6. **Flask** (××•×¤×¦×™×•× ×œ×™) - ×œ× ×™×”×•×œ ×××©×§ × ×™×”×•×œ ×× ×™×™×“×¨×©

### 3.2 ××‘× ×” ×”× ×ª×•× ×™×

#### ××¡×“ × ×ª×•× ×™× ××™×œ×™×
```json
{
  "word_id": "unique_id",
  "english": "example",
  "hebrew": "×“×•×’××”",
  "part_of_speech": "noun",
  "difficulty_level": 2,
  "examples": [
    "This is an example sentence.",
    "Can you give me an example?"
  ],
  "synonyms": ["sample", "instance", "illustration"],
  "topic_tags": ["general", "academic"]
}
```

#### × ×ª×•× ×™ ××©×ª××©
```json
{
  "user_id": "telegram_user_id",
  "username": "username",
  "join_date": "2025-02-26",
  "current_level": 3,
  "learning_preferences": {
    "preferred_topics": ["business", "travel"],
    "daily_goal": 10,
    "preferred_activities": ["flashcards", "stories"]
  },
  "progress": {
    "words_mastered": 150,
    "words_learning": [
      {
        "word_id": "word_unique_id",
        "status": "learning", // "new", "learning", "mastered"
        "repetitions": 5,
        "next_review": "2025-02-28",
        "success_rate": 0.8
      }
    ],
    "daily_streaks": 7,
    "total_practice_time": 840, // minutes
    "achievement_badges": ["7_day_streak", "100_words_mastered"]
  },
  "session_data": {
    "current_activity": "flashcards",
    "current_word_set": ["word_id_1", "word_id_2"],
    "conversation_context": {}
  }
}
```

#### ×¡×˜×˜×™×¡×˜×™×§×•×ª ×©×™××•×©
```json
{
  "date": "2025-02-26",
  "total_users": 120,
  "active_users": 85,
  "activities_completed": {
    "flashcards": 250,
    "stories": 42,
    "writing_challenges": 36
  },
  "popular_words": [
    {"word_id": "id1", "attempts": 56},
    {"word_id": "id2", "attempts": 48}
  ],
  "difficult_words": [
    {"word_id": "id3", "success_rate": 0.4},
    {"word_id": "id4", "success_rate": 0.45}
  ]
}
```

## 4. ×¤×™×¦'×¨×™× ×•×¤×•× ×§×¦×™×•× ×œ×™×•×ª

### 4.1 ××•×“×•×œ ×”×¨×©××” ×•×”×ª×—×œ×”

1. ×‘×¨×›×ª ×¤×ª×™×—×” ×•×”×¡×‘×¨ ×§×¦×¨ ×¢×œ ×”×‘×•×˜
2. ××™×¡×•×£ ×¤×¨×˜×™× ×¨××©×•× ×™×™×: ×©×, ×¨××ª ×× ×’×œ×™×ª × ×•×›×—×™×ª, ××˜×¨×•×ª ×œ×™××•×“
3. ×‘×“×™×§×ª ×¨××” ×¨××©×•× ×™×ª (××•×¤×¦×™×•× ×œ×™) ×œ×§×‘×™×¢×ª × ×§×•×“×ª ×”×ª×—×œ×”
4. ×”×¦×’×ª ××“×¨×™×š ×§×¦×¨ ×œ×©×™××•×© ×‘×‘×•×˜
5. ×”×¦×¢×ª ×¤×¢×™×œ×•×ª ×¨××©×•× ×”

### 4.2 ××¢×¨×›×ª ×œ××™×“×” ×•×ª×¨×’×•×œ

#### 4.2.1 ×›×¨×˜×™×¡×™×•×ª ×–×™×›×¨×•×Ÿ (Flashcards)
- ×”×¦×’×ª ××™×œ×” ×‘×× ×’×œ×™×ª ×•×‘×™×§×•×© ×ª×¨×’×•×
- ×”×¦×’×ª ××™×œ×” ×‘×¢×‘×¨×™×ª ×•×‘×™×§×•×© ×ª×¨×’×•×
- ×ª××™×›×” ×‘×œ×™××•×“ ×”×“×¨×’×ª×™ (spaced repetition)
- ××ª×Ÿ ××©×•×‘ ××™×“×™ ×¢×œ ×ª×©×•×‘×•×ª

#### 4.2.2 ××©×—×§×™ ××™×œ×™×
- ××™×œ×” ×—×¡×¨×” ×‘××©×¤×˜
- ×”×ª×××ª ××™×œ×™× ×œ×ª××•× ×•×ª ××• ×”×’×“×¨×•×ª
- ××©×—×§×™ ×–×™×›×¨×•×Ÿ (memory matching)
- ×ª×—×¨×•×™×•×ª × ×’×“ ×”×–××Ÿ
- ××©×—×§ "×ª×œ×™×™×”" ×¢× ××™×œ×™× ×××•×¦×¨ ×”××™×œ×™× ×”× ×œ××“

#### 4.2.3 ×¡×™×¤×•×¨×™× ××™× ×˜×¨××§×˜×™×‘×™×™×
- ×™×¦×™×¨×ª ×¡×™×¤×•×¨×™× ×§×¦×¨×™× ×¢× ××™×œ×™× ××”×××’×¨
- ×¡×™×¤×•×¨×™× ××•×ª×××™× ××™×©×™×ª ×œ×¤×™ ×ª×—×•××™ ×¢× ×™×™×Ÿ
- ×©××œ×•×ª ×”×‘× ×” ×‘×¡×•×£ ×›×œ ×¡×™×¤×•×¨
- ××¤×©×¨×•×ª ×œ×”×©×œ××ª ××™×œ×™× ×—×¡×¨×•×ª ×‘×¡×™×¤×•×¨

#### 4.2.4 ××ª×’×¨×™ ×›×ª×™×‘×”
- × ×•×©××™× ×™×•××™×™× ×œ×›×ª×™×‘×ª ×˜×§×¡×˜ ×§×¦×¨
- ×”× ×—×™×™×” ×œ×©×™××•×© ×‘××™×œ×™× ×¡×¤×¦×™×¤×™×•×ª ××”×××’×¨
- ××©×•×‘ ××•×˜×•××˜×™ ×¢×œ ×©×™××•×© ×‘××™×œ×™×, ×“×§×“×•×§, ××‘× ×” ××©×¤×˜×™×
- ×“×™×¨×•×’ ×¨××ª ×”×›×ª×™×‘×” ×•×”×¦×¢×•×ª ×œ×©×™×¤×•×¨

#### 4.2.5 ×¦'××˜ ××™× ×˜×¨××§×˜×™×‘×™
- ×©×™×—×•×ª ×—×•×¤×©×™×•×ª ×¢× ×”×‘×•×˜ ×‘× ×•×©××™× ×©×•× ×™×
- ×©×™×œ×•×‘ ××™×œ×™× ×—×“×©×•×ª ×‘×ª×•×š ×”×©×™×—×”
- ×ª×™×§×•×Ÿ ×˜×¢×•×™×•×ª ×‘×–××Ÿ ×××ª
- ×”×ª×××ª ×¨××ª ×”×©×™×—×” ×œ×¨××ª ×”××©×ª××©

### 4.3 ××¢×¨×›×ª ××¢×§×‘ ×•×”×ª×§×“××•×ª

1. ×“×•×— ×™×•××™ ×¢×œ ××™×œ×™× ×©× ×œ××“×•
2. ×’×¨×£ ×”×ª×§×“××•×ª ×©×‘×•×¢×™/×—×•×“×©×™
3. ×¡×˜×˜×™×¡×˜×™×§×•×ª ×‘×™×¦×•×¢×™× ×œ×¤×™ ×¡×•×’×™ ×¤×¢×™×œ×•×™×•×ª
4. ×–×™×”×•×™ × ×§×•×“×•×ª ×—×•×–×§ ×•×—×•×œ×©×”
5. ×ª×’×™× ×•×”×™×©×’×™× ×œ××•×˜×™×‘×¦×™×”
6. ×”×ª×¨××•×ª ×¢×œ ××™×œ×™× ×©×¦×¨×™×š ×œ×—×–×•×¨ ×¢×œ×™×”×Ÿ

### 4.4 ××•×“×•×œ ×”×ª×××” ××™×©×™×ª

1. ×‘×—×™×¨×ª ×ª×—×•××™ ×¢× ×™×™×Ÿ ×œ×›×™×•×•×Ÿ ×”×œ×™××•×“
2. ×§×‘×™×¢×ª ×™×¢×“×™× ×™×•××™×™×/×©×‘×•×¢×™×™×
3. ×‘×—×™×¨×ª ×¤×¢×™×œ×•×™×•×ª ××•×¢×“×¤×•×ª
4. ×§×‘×™×¢×ª ×–×× ×™ ×ª×¨×’×•×œ ×•×ª×–×›×•×¨×•×ª
5. ×”×ª×××ª ×§×¦×‘ ×”×œ×™××•×“

## 5. ×ª×–×¨×™× ×¢×‘×•×“×” (Workflow)

### 5.1 ×ª×–×¨×™× ×›×œ×œ×™

1. ×”××©×ª××© ××ª×—×™×œ ×©×™×—×” ×¢× ×”×‘×•×˜
2. ×”×‘×•×˜ ××–×”×” ×× ××“×•×‘×¨ ×‘××©×ª××© ×—×“×© ××• ×—×•×–×¨
3. ×œ××©×ª××© ×—×“×©: ×”×‘×•×˜ ××¦×™×’ ×ª×”×œ×™×š ×”×¨×©××”
4. ×œ××©×ª××© ×—×•×–×¨: ×”×‘×•×˜ ×˜×•×¢×Ÿ ××ª ×”×¤×¨×•×¤×™×œ ×•×”××¦×‘ ×”×§×•×“×
5. ×”×‘×•×˜ ××¦×™×¢ ×¤×¢×™×œ×•×ª ×”×‘××”, ×‘×”×ª×‘×¡×¡ ×¢×œ:
   - ×ª×•×›× ×™×ª ×”×œ×™××•×“×™×
   - ×”×”×ª×§×“××•×ª ×”×§×•×“××ª
   - ×”×¢×“×¤×•×ª ×”××©×ª××©
   - ×”×–××Ÿ ×©×—×œ×£ ×××– ×”×¤×¢×™×œ×•×ª ×”××—×¨×•× ×”
6. ×”××©×ª××© ×‘×•×—×¨ ×¤×¢×™×œ×•×ª ××• ××‘×§×© ××¤×©×¨×•×™×•×ª ××—×¨×•×ª
7. ×”×‘×•×˜ ×× ×”×œ ××ª ×”×¤×¢×™×œ×•×ª ×©× ×‘×—×¨×”
8. ×‘×¡×™×•× ×”×¤×¢×™×œ×•×ª, ×”×‘×•×˜ ××¢×“×›×Ÿ ××ª × ×ª×•× ×™ ×”×”×ª×§×“××•×ª
9. ×”×‘×•×˜ ××¦×™×¢ ×¤×¢×™×œ×•×ª ×”×‘××” ××• ××¡×›× ××ª ×”×”×™×©×’×™×

### 5.2 ×ª×–×¨×™× ×¤×¢×™×œ×•×ª ×œ×™××•×“ ××™×œ×™×

```
START
|
v
+-------------------+
| ×”×¦×’×ª ××™×œ×” ×—×“×©×”   |
+-------------------+
|
v
+-------------------+
| ×”×¡×‘×¨ + ×“×•×’×××•×ª   |
+-------------------+
|
v
+-------------------+
| ×‘×§×©×ª ×ª×¨×’×•×/×–×™×”×•×™ |
+-------------------+
|
v
+-------------------+
| ×‘×“×™×§×ª ×ª×©×•×‘×”      |
+-------------------+
|       |
v       v
+-------+   +-------+
| × ×›×•×Ÿ  |   | ×©×’×•×™  |
+-------+   +-------+
|           |
v           v
+-------+   +-------+
| ×—×™×–×•×§ |   | ×”×¡×‘×¨  |
+-------+   +-------+
|           |
v           v
+-------------------+
| ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª |
+-------------------+
|
v
+-------------------+
| ×‘×—×™×¨×ª ××™×œ×” ×”×‘××”  |
+-------------------+
|
v
END
```

### 5.3 ×ª×–×¨×™× ××ª×’×¨ ×›×ª×™×‘×”

```
START
|
v
+-------------------+
| ×”×¦×’×ª × ×•×©× ×›×ª×™×‘×”  |
+-------------------+
|
v
+-------------------+
| ×“×¨×™×©×•×ª (××™×œ×™×    |
| ×œ×©×™××•×©, ××•×¨×š)    |
+-------------------+
|
v
+-------------------+
| ×§×‘×œ×ª ×˜×§×¡×˜        |
| ××”××©×ª××©          |
+-------------------+
|
v
+-------------------+
| × ×™×ª×•×— ×”×˜×§×¡×˜      |
| (Gemini API)      |
+-------------------+
|
v
+-------------------+
| ××©×•×‘ ×¢×œ:          |
| - ×©×™××•×© ×‘××™×œ×™×    |
| - ×“×§×“×•×§           |
| - ××‘× ×”            |
| - ××§×•×¨×™×•×ª         |
+-------------------+
|
v
+-------------------+
| ×”×¦×¢×•×ª ×œ×©×™×¤×•×¨     |
+-------------------+
|
v
+-------------------+
| ×©××™×¨×ª ×”×˜×§×¡×˜      |
| ×‘×¤×•×¨×˜×¤×•×œ×™×•       |
+-------------------+
|
v
+-------------------+
| ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª |
+-------------------+
|
v
END
```

## 6. ×©×™××•×© ×‘-Gemini API

### 6.1 ××©×™××•×ª ×¢×™×§×¨×™×•×ª

1. **×™×™×¦×•×¨ ×ª×•×›×Ÿ ×“×™× ××™**:
   - ×™×¦×™×¨×ª ×¡×™×¤×•×¨×™× ×¢× ××™×œ×™× ×¡×¤×¦×™×¤×™×•×ª
   - ×™×¦×™×¨×ª ×ª×¨×’×™×œ×™× ××•×ª×××™× ××™×©×™×ª
   - ×™×¦×™×¨×ª ×”×¡×‘×¨×™× ××¤×•×¨×˜×™× ×œ××™×œ×™× ×•××•× ×—×™×

2. **× ×™×ª×•×— ×ª×•×›×Ÿ ××©×ª××©**:
   - ×‘×“×™×§×ª ×ª×¨×’×•××™× ×•×›×ª×™×‘×” ×—×•×¤×©×™×ª
   - ×–×™×”×•×™ ×˜×¢×•×™×•×ª ×“×§×“×•×§×™×•×ª
   - ×”×¢×¨×›×ª ×¨××ª ×”×›×ª×™×‘×”

3. **×©×™×—×” ××™× ×˜×¨××§×˜×™×‘×™×ª**:
   - × ×™×”×•×œ ×©×™×—×•×ª ×¢×œ × ×•×©××™× ×©×•× ×™×
   - ×”×ª×××ª ×¨××ª ×”×©×™×—×” ×œ×¨××ª ×”××©×ª××©
   - ×©×™×œ×•×‘ ××™×œ×™× ×—×“×©×•×ª ×‘×ª×•×š ×”×”×§×©×¨

### 6.2 ×¤×¨×•××¤×˜×™× ×œ×“×•×’××”

#### ×™×¦×™×¨×ª ×¡×™×¤×•×¨
```
×™×™×¦×¨ ×¡×™×¤×•×¨ ×§×¦×¨ (100-150 ××™×œ×™×) ×‘×¨××ª ×§×¨×™××” {reading_level} 
×”××©×œ×‘ ××ª ×”××™×œ×™× ×”×‘××•×ª: {word_list}.
×”×¡×™×¤×•×¨ ×¦×¨×™×š ×œ×¢×¡×•×§ ×‘× ×•×©× {topic} ×•×œ×›×œ×•×œ ×“×™××œ×•×’.
×”×§×¤×“ ×©×”×©×™××•×© ×‘××™×œ×™× ×™×”×™×” ×˜×‘×¢×™ ×•×‘×”×§×©×¨ × ×›×•×Ÿ.
```

#### × ×™×ª×•×— ×˜×§×¡×˜ ×©× ×›×ª×‘
```
×”×˜×§×¡×˜ ×”×‘× × ×›×ª×‘ ×¢×œ ×™×“×™ ×œ×•××“ ×× ×’×œ×™×ª:
{user_text}

× ×ª×— ××ª ×”×˜×§×¡×˜ ×•×¡×¤×§ ××©×•×‘ ×¢×œ:
1. ×©×™××•×© × ×›×•×Ÿ ×‘××™×œ×™×: {words_to_use}
2. ×“×™×•×§ ×“×§×“×•×§×™ (×¡××Ÿ ×˜×¢×•×™×•×ª ×•×ª×§×Ÿ ××•×ª×Ÿ)
3. ××‘× ×” ××©×¤×˜×™× ×•×¤×¡×§××•×ª
4. ×”×¦×¢×•×ª ×¡×¤×¦×™×¤×™×•×ª ×œ×©×™×¤×•×¨ (3-5 ×”×¦×¢×•×ª)
5. ×ª×Ÿ ×¦×™×•×Ÿ ×›×œ×œ×™ (1-10) ×•×”×¡×‘×¨ ×§×¦×¨

×”×ª×©×•×‘×” ×¦×¨×™×›×” ×œ×”×™×•×ª ×× ×•×¡×—×ª ×‘×¦×•×¨×” ××¢×•×“×“×ª ×•×‘×•× ×”.
```

#### ×“×™××œ×•×’ ×œ×™××•×“×™
```
× ×”×œ ×©×™×—×” ×‘× ×•×©× {topic} ×¢× ×œ×•××“ ×× ×’×œ×™×ª ×‘×¨××” {level}.
×›×œ×•×œ ××ª ×”××™×œ×™× ×”×‘××•×ª ×‘×ª×©×•×‘×•×ª×™×š ×‘×¦×•×¨×” ×˜×‘×¢×™×ª: {word_list}.
××•×¨×š ×”×ª×©×•×‘×•×ª ×©×œ×š ×¦×¨×™×š ×œ×”×™×•×ª {response_length}.
×× ×”××©×ª××© ×¢×•×©×” ×˜×¢×•×™×•×ª, ×ª×§×Ÿ ××•×ª×Ÿ ×‘×¢×“×™× ×•×ª.
×©××œ ×©××œ×•×ª ×©×™×¢×•×“×“×• ×©×™××•×© ×‘××™×œ×™× ×-{word_list}.

×”×”×•×“×¢×” ×”××—×¨×•× ×” ×©×œ ×”××©×ª××©: {user_message}
×”×§×©×¨ ×”×©×™×—×” ×”×§×•×“×: {conversation_history}
```

## 7. ×××©×§ ××©×ª××©

### 7.1 ×¤×§×•×“×•×ª ×‘×•×˜ ×¢×™×§×¨×™×•×ª

- `/start` - ×”×ª×—×œ×ª ×©×™××•×© ×‘×‘×•×˜ / ×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×¨××©×™
- `/help` - ×”×¡×‘×¨ ×¢×œ ×”×©×™××•×© ×‘×‘×•×˜
- `/profile` - ×¦×¤×™×™×” ×‘×¤×¨×•×¤×™×œ ××™×©×™ ×•×”×ª×§×“××•×ª
- `/practice` - ×”×ª×—×œ×ª ×ª×¨×’×•×œ ××™×œ×™×
- `/game` - ××©×—×§×™ ××™×œ×™×
- `/story` - ×§×¨×™××ª ×¡×™×¤×•×¨ ××™× ×˜×¨××§×˜×™×‘×™
- `/write` - ××ª×’×¨ ×›×ª×™×‘×”
- `/chat` - ×¦'××˜ ××™× ×˜×¨××§×˜×™×‘×™
- `/daily` - ××ª×’×¨ ×™×•××™
- `/settings` - ×”×’×“×¨×•×ª ×•×”×ª×××” ××™×©×™×ª

### 7.2 ××‘× ×” ×ª×¤×¨×™×˜×™×

#### ×ª×¤×¨×™×˜ ×¨××©×™
- ğŸ”¤ ×ª×¨×’×•×œ ××™×œ×™×
- ğŸ® ××©×—×§×™×
- ğŸ“š ×¡×™×¤×•×¨×™×
- âœï¸ ××ª×’×¨×™ ×›×ª×™×‘×”
- ğŸ’¬ ×¦'××˜ ××™× ×˜×¨××§×˜×™×‘×™
- ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ×•×”×ª×§×“××•×ª
- âš™ï¸ ×”×’×“×¨×•×ª

#### ×ª×¤×¨×™×˜ ××©×—×§×™×
- ğŸ¯ ×”×©×œ××ª ××©×¤×˜×™×
- ğŸ§© ×–×™×”×•×™ ××™×œ×™× ×œ×¤×™ ×”×’×“×¨×”
- ğŸ­ ××©×—×§ ×ª×¤×§×™×“×™×
- â± ××ª×’×¨ ×–××Ÿ
- ğŸª ××©×—×§ ×ª×œ×™×™×”

#### ×ª×¤×¨×™×˜ ×”×’×“×¨×•×ª
- ğŸ¯ ×™×¢×“×™× ×™×•××™×™×
- ğŸ“‹ ×ª×—×•××™ ×¢× ×™×™×Ÿ
- ğŸ”” ×ª×–×›×•×¨×•×ª
- ğŸš ×¨××ª ×§×•×©×™
- ğŸ¨ ×”×¢×“×¤×•×ª ×œ×™××•×“

## 8. ×œ×•×’×™×§×” ×¢×¡×§×™×ª

### 8.1 ××œ×’×•×¨×™×ª× ×œ××™×“×” ×¡×¤×¦×™×¤×™ (Spaced Repetition)

××¢×¨×›×ª ×”-Spaced Repetition ×ª×¢×§×•×‘ ××—×¨ ×ª×”×œ×™×š ×”×œ××™×“×” ×©×œ ×›×œ ××™×œ×”:

1. ××™×œ×” ×—×“×©×” ××•×¦×’×ª ×œ××©×ª××©
2. ×œ××—×¨ ×”×¦×’×” ×¨××©×•× ×”, ×”××™×œ×” ×ª×•×¤×™×¢ ×©×•×‘ ××—×¨×™ 4 ×©×¢×•×ª
3. ×× ×”××©×ª××© ×–×•×›×¨ × ×›×•×Ÿ, ×”××¨×•×•×— ××•×›×¤×œ (8 ×©×¢×•×ª, 16 ×©×¢×•×ª, ×•×›×•')
4. ×× ×”××©×ª××© ×˜×•×¢×”, ×”××¨×•×•×— ××ª×§×¦×¨ ×‘-50%
5. ××™×œ×” × ×—×©×‘×ª "××•×˜××¢×ª" ××—×¨×™ 5 ×ª×©×•×‘×•×ª × ×›×•× ×•×ª ×‘×¨×¦×™×¤×•×ª
6. ××™×œ×™× "××•×˜××¢×•×ª" ×¢×•×‘×¨×•×ª ×œ×‘×“×™×§×•×ª ×ª×§×•×¤×ª×™×•×ª (×¤×¢× ×‘×©×‘×•×¢, ×‘×—×•×“×© ×•×›×•')

### 8.2 ×”××œ×¦×•×ª ×ª×•×›×Ÿ ××™×©×™×•×ª

×”×‘×•×˜ ×™×©×ª××© ×‘××œ×’×•×¨×™×ª× ×”××œ×¦×•×ª ×œ×”×¦×¢×ª ×¤×¢×™×œ×•×™×•×ª ×”×‘××•×ª:

1. × ×™×ª×•×— ×“×¤×•×¡×™ ×œ××™×“×” ××™×©×™×™×
2. ×–×™×”×•×™ ×–×× ×™ ×œ××™×“×” ××•×¢×“×¤×™×
3. ×–×™×”×•×™ ×¡×•×’×™ ×¤×¢×™×œ×•×™×•×ª ×¢× ×”×¦×œ×—×” ×’×‘×•×”×”
4. ×”×ª×—×©×‘×•×ª ×‘××©×š ×–××Ÿ ×¤×¢×™×œ×•×ª ××—×¨×•× ×”
5. ×©×§×œ×•×œ ×‘×™×¦×•×¢×™× ×§×•×“××™× ×‘×¤×¢×™×œ×•×™×•×ª ×“×•××•×ª

### 8.3 ××¢×¨×›×ª ×”×ª×¨××•×ª ×•×”×ª×–×›×•×¨×•×ª

1. ×ª×–×›×•×¨×•×ª ×™×•××™×•×ª ×‘×–×× ×™× ×©×”××©×ª××© ×‘×—×¨
2. ×”×ª×¨××•×ª ×¢×œ ××™×œ×™× ×©×¦×¨×™×š ×œ×—×–×•×¨ ×¢×œ×™×”×Ÿ
3. ×—×™×–×•×§×™× ×—×™×•×‘×™×™× ×¢×œ ×”×ª×§×“××•×ª
4. ×”×ª×¨××•×ª ×¢×œ ×™×¨×™×“×” ×‘×¤×¢×™×œ×•×ª
5. ×ª×–×›×•×¨×•×ª ×¢×œ ××ª×’×¨×™× ×•××©×™××•×ª ××™×•×—×“×•×ª

## 9. ×ª×”×œ×™×š ×¤×™×ª×•×—

### 9.1 ×©×œ×‘×™ ×¤×™×ª×•×— ××•××œ×¦×™×

1. **×©×œ×‘ 1: ××‘× ×” ×‘×¡×™×¡×™**
   - ×”×§××ª ××‘× ×” ×”×‘×•×˜ ×”×‘×¡×™×¡×™
   - ×—×™×‘×•×¨ ×œ-Telegram API
   - ×™×¦×™×¨×ª ××¢×¨×›×ª × ×™×”×•×œ ××¦×‘×™ ×©×™×—×”
   - ×”×’×“×¨×ª ×¤×§×•×“×•×ª ×‘×¡×™×¡×™×•×ª

2. **×©×œ×‘ 2: ××¡×“ × ×ª×•× ×™×**
   - ×”×§××ª ××¡×“ ×”× ×ª×•× ×™×
   - ×™×™×‘×•× ××•×¦×¨ ×”××™×œ×™× (4,300 ××™×œ×™×)
   - ××¢×¨×›×ª × ×™×”×•×œ ×¤×¨×•×¤×™×œ×™ ××©×ª××©×™×

3. **×©×œ×‘ 3: ×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×‘×¡×™×¡×™×ª**
   - ×”×¨×©××ª ××©×ª××©×™×
   - ×ª×¨×’×•×œ ×‘×¡×™×¡×™ ×©×œ ××™×œ×™× (flashcards)
   - ××¢×§×‘ ××—×¨ ×”×ª×§×“××•×ª ×¨××©×•× ×™×ª

4. **×©×œ×‘ 4: ××™× ×˜×’×¨×¦×™×” ×¢× Gemini API**
   - ×”×˜××¢×ª ×”-API
   - ×™×¦×™×¨×ª ×¤×¨×•××¤×˜×™× ×‘×¡×™×¡×™×™×
   - ×™×¦×™×¨×ª ××¢×¨×›×ª × ×™×ª×•×— ×ª×©×•×‘×•×ª ××©×ª××©

5. **×©×œ×‘ 5: ×”×•×¡×¤×ª ×¤×¢×™×œ×•×™×•×ª ××ª×§×“××•×ª**
   - ××©×—×§×™× ××•×¨×›×‘×™× ×™×•×ª×¨
   - ×¡×™×¤×•×¨×™× ××™× ×˜×¨××§×˜×™×‘×™×™×
   - ××ª×’×¨×™ ×›×ª×™×‘×”
   - ×¦'××˜ ××™× ×˜×¨××§×˜×™×‘×™

6. **×©×œ×‘ 6: ×”×ª×××” ××™×©×™×ª**
   - ××¢×¨×›×ª ×”×¢×“×¤×•×ª ××ª×§×“××ª
   - ××œ×’×•×¨×™×ª× ×”××œ×¦×•×ª
   - ×”×ª×××ª ×§×•×©×™ ××•×˜×•××˜×™×ª

7. **×©×œ×‘ 7: ×‘×“×™×§×•×ª ×•××©×•×‘**
   - ×‘×“×™×§×•×ª ×‘×™×¦×•×¢×™×
   - ××™×¡×•×£ ××©×•×‘ ×××©×ª××©×™×
   - ×©×™×¤×•×¨×™× ×•×ª×™×§×•× ×™×

### 9.2 ×§×•×“ ×œ×“×•×’××” - ××‘× ×” ×‘×¡×™×¡×™

```python
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, CallbackQueryHandler, ContextTypes, filters
import logging
import os
import json
import pymongo
import redis
import google.generativeai as genai
from datetime import datetime, timedelta

# Configuration
API_TOKEN = os.environ.get("TELEGRAM_API_TOKEN")
GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")
MONGO_URI = os.environ.get("MONGO_URI")
REDIS_URI = os.environ.get("REDIS_URI")

# Setup logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# Initialize Gemini API
genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel('gemini-pro')

# Initialize MongoDB
mongo_client = pymongo.MongoClient(MONGO_URI)
db = mongo_client["english_learning_bot"]
users_collection = db["users"]
words_collection = db["words"]
stats_collection = db["statistics"]

# Initialize Redis
redis_client = redis.Redis.from_url(REDIS_URI)

# User states
class UserState:
    IDLE = "idle"
    REGISTERING = "registering"
    PRACTICING = "practicing"
    PLAYING_GAME = "playing_game"
    READING_STORY = "reading_story"
    WRITING = "writing"
    CHATTING = "chatting"
    SETTINGS = "settings"

# Helper functions
async def get_user_data(user_id):
    user = users_collection.find_one({"user_id": user_id})
    if not user:
        return None
    return user

async def save_user_data(user_data):
    users_collection.replace_one(
        {"user_id": user_data["user_id"]},
        user_data,
        upsert=True
    )

async def get_random_words(count, difficulty=None, topics=None):
    query = {}
    if difficulty:
        query["difficulty_level"] = difficulty
    if topics:
        query["topic_tags"] = {"$in": topics}
    
    words = list(words_collection.aggregate([
        {"$match": query},
        {"$sample": {"size": count}}
    ]))
    
    return words

async def generate_story(words, topic, level):
    prompt = f"""
    ×™×™×¦×¨ ×¡×™×¤×•×¨ ×§×¦×¨ (150-200 ××™×œ×™×) ×‘×¨××ª ×§×¨×™××” {level} 
    ×”××©×œ×‘ ××ª ×”××™×œ×™× ×”×‘××•×ª: {', '.join(words)}.
    ×”×¡×™×¤×•×¨ ×¦×¨×™×š ×œ×¢×¡×•×§ ×‘× ×•×©× {topic} ×•×œ×›×œ×•×œ ×“×™××œ×•×’.
    ×”×§×¤×“ ×©×”×©×™××•×© ×‘××™×œ×™× ×™×”×™×” ×˜×‘×¢×™ ×•×‘×”×§×©×¨ × ×›×•×Ÿ.
    """
    
    response = model.generate_content(prompt)
    return response.text

# Command handlers
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_data = await get_user_data(user.id)
    
    if not user_data:
        # New user
        await update.message.reply_text(
            f"×‘×¨×•×š ×”×‘×, {user.first_name}! ×× ×™ ×‘×•×˜ ×œ×œ×™××•×“ ×× ×’×œ×™×ª. "\
            "×× ×™ ××¢×–×•×¨ ×œ×š ×œ×©×¤×¨ ××ª ××•×¦×¨ ×”××™×œ×™× ×•×”×›×™×©×•×¨×™× ×©×œ×š ×‘×× ×’×œ×™×ª."
        )
        
        # Create new user profile
        user_data = {
            "user_id": user.id,
            "username": user.username,
            "join_date": datetime.now().strftime("%Y-%m-%d"),
            "current_level": 1,
            "learning_preferences": {
                "preferred_topics": [],
                "daily_goal": 10,
                "preferred_activities": []
            },
            "progress": {
                "words_mastered": 0,
                "words_learning": [],
                "daily_streaks": 0,
                "total_practice_time": 0,
                "achievement_badges": []
            },
            "session_data": {
                "current_activity": None,
                "current_word_set": [],
                "conversation_context": {}
            }
        }
        
        await save_user_data(user_data)
        
        # Start registration process
        context.user_data["state"] = UserState.REGISTERING
        await update.message.reply_text(
            "×‘×•× × ×ª×—×™×œ ×‘×”×’×“×¨×ª ×”×¤×¨×•×¤×™×œ ×©×œ×š. "\
            "××”×™ ×¨××ª ×”×× ×’×œ×™×ª ×©×œ×š? (××ª×—×™×œ/×‘×™× ×•× ×™/××ª×§×“×)"
        )
    else:
        # Returning user
        keyboard = [
            [
                InlineKeyboardButton("ğŸ”¤ ×ª×¨×’×•×œ ××™×œ×™×", callback_data="practice"),
                InlineKeyboardButton("ğŸ® ××©×—×§×™×", callback_data="games")
            ],
            [
                InlineKeyboardButton("ğŸ“š ×¡×™×¤×•×¨×™×", callback_data="stories"),
                InlineKeyboardButton("âœï¸ ××ª×’×¨×™ ×›×ª×™×‘×”", callback_data="writing")
            ],
            [
                InlineKeyboardButton("ğŸ’¬ ×¦'××˜", callback_data="chat"),
                InlineKeyboardButton("ğŸ“Š ×”×ª×§×“××•×ª", callback_data="progress")
            ],
            [
                InlineKeyboardButton("âš™ï¸ ×”×’×“×¨×•×ª", callback_data="settings")
            ]
        ]
        
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        # Calculate streak and update if needed
        last_active = datetime.strptime(user_data.get("last_active", user_data["join_date"]), "%Y-%m-%d")
        today = datetime.now().date()
        yesterday = (datetime.now() - timedelta(days=1)).date()
        
        if last_active.date() == yesterday:
            user_data["progress"]["daily_streaks"] += 1
        elif last_active.date() != today:
            user_data["progress"]["daily_streaks"] = 1
            
        user_data["last_active"] = today.strftime("%Y-%m-%d")
        await save_user_data(user_data)
        
        await update.message.reply_text(
            f"×©×œ×•× {user.first_name}! " \
            f"×¡×˜×¨×™×§ ×™×•××™: ğŸ”¥ {user_data['progress']['daily_streaks']} ×™××™×\n" \
            f"××™×œ×™× ×©× ×œ××“×•: {user_data['progress']['words_mastered']} ××ª×•×š 4,300\n\n" \
            "××” ×ª×¨×¦×” ×œ×¢×©×•×ª ×”×™×•×?",
            reply_markup=reply_markup
        )
        
        context.user_data["state"] = UserState.IDLE

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    help_text = """
    ×”×‘×•×˜ ×œ×œ×™××•×“ ×× ×’×œ×™×ª - ×¤×§×•×“×•×ª ×¢×™×§×¨×™×•×ª:
    
    /start - ×”×ª×—×œ ×©×™×—×” ×¢× ×”×‘×•×˜ ××• ×—×–×•×¨ ×œ×ª×¤×¨×™×˜ ×”×¨××©×™
    /help - ×”×¦×’ ×”×•×“×¢×ª ×¢×–×¨×” ×–×•
    /profile - ×¦×¤×” ×‘×¤×¨×•×¤×™×œ ×©×œ×š ×•×”×ª×§×“××•×ª
    /practice - ×”×ª×—×œ ×ª×¨×’×•×œ ××™×œ×™×
    /game - ×©×—×§ ××©×—×§×™ ××™×œ×™×
    /story - ×§×¨× ×¡×™×¤×•×¨ ××™× ×˜×¨××§×˜×™×‘×™
    /write - ×”×ª×—×œ ××ª×’×¨ ×›×ª×™×‘×”
    /chat - ×”×ª×—×œ ×¦'××˜ ××™× ×˜×¨××§×˜×™×‘×™
    /daily - ×§×‘×œ ××ª ×”××ª×’×¨ ×”×™×•××™
    /settings - ×©× ×” ×”×’×“×¨×•×ª ××™×©×™×•×ª
    """
    
    await update.message.reply_text(help_text)

async def profile_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_data = await get_user_data(user.id)
    
    if not user_data:
        await update.message.reply_text(
            "× ×¨××” ×©×¢×“×™×™×Ÿ ×œ× × ×¨×©××ª. ×”×©×ª××© ×‘×¤×§×•×“×” /start ×›×“×™ ×œ×”×ª×—×™×œ."
        )
        return
    
    # Calculate progress percentage
    progress_percent = (user_data["progress"]["words_mastered"] / 4300) * 100
    
    # Get recent activity
    recent_activities = user_data.get("recent_activities", [])
    recent_activity_text = "\n".join([f"- {activity}" for activity in recent_activities[-3:]]) if recent_activities else "××™×Ÿ ×¤×¢×™×œ×•×ª ××—×¨×•× ×”"
    
    # Format badges
    badges = user_data["progress"]["achievement_badges"]
    badge_text = ", ".join(badges) if badges else "××™×Ÿ ×¢×“×™×™×Ÿ ×”×™×©×’×™×"
    
    profile_text = f"""
    ğŸ“Š ×”×¤×¨×•×¤×™×œ ×©×œ×š:
    
    ğŸ‘¤ ×©×: {user.first_name}
    ğŸ“… ×”×¦×˜×¨×¤×ª ×‘×ª××¨×™×š: {user_data["join_date"]}
    ğŸ”¥ ×¡×˜×¨×™×§ ×™×•××™: {user_data["progress"]["daily_streaks"]} ×™××™×
    
    ğŸ“š ×”×ª×§×“××•×ª:
    - ××™×œ×™× ×©× ×œ××“×•: {user_data["progress"]["words_mastered"]} / 4300 ({progress_percent:.1f}%)
    - ×–××Ÿ ×œ×™××•×“ ×›×•×œ×œ: {user_data["progress"]["total_practice_time"]} ×“×§×•×ª
    
    ğŸ† ×”×™×©×’×™×:
    {badge_text}
    
    ğŸ” ×¤×¢×™×œ×•×ª ××—×¨×•× ×”:
    {recent_activity_text}
    """
    
    # Add inline buttons for more detailed stats
    keyboard = [
        [
            InlineKeyboardButton("ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ××¤×•×¨×˜×•×ª", callback_data="detailed_stats"),
            InlineKeyboardButton("ğŸ—“ï¸ ×”×™×¡×˜×•×¨×™×™×ª ×œ××™×“×”", callback_data="learning_history")
        ],
        [
            InlineKeyboardButton("ğŸ”™ ×—×–×¨×” ×œ×ª×¤×¨×™×˜", callback_data="back_to_menu")
        ]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(profile_text, reply_markup=reply_markup)

# Callback query handler
async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user = query.from_user
    user_data = await get_user_data(user.id)
    
    if query.data == "practice":
        # Start word practice session
        words = await get_random_words(10, 
                                       difficulty=user_data.get("current_level", 1),
                                       topics=user_data.get("learning_preferences", {}).get("preferred_topics", []))
        
        context.user_data["current_words"] = words
        context.user_data["current_word_index"] = 0
        context.user_data["state"] = UserState.PRACTICING
        
        await show_next_word(query.message, context)
        
    elif query.data == "games":
        # Show games menu
        keyboard = [
            [
                InlineKeyboardButton("ğŸ¯ ×”×©×œ××ª ××©×¤×˜×™×", callback_data="game_complete_sentence"),
                InlineKeyboardButton("ğŸ§© ×–×™×”×•×™ ××™×œ×™×", callback_data="game_word_definition")
            ],
            [
                InlineKeyboardButton("ğŸ­ ××©×—×§ ×ª×¤×§×™×“×™×", callback_data="game_role_play"),
                InlineKeyboardButton("â± ××ª×’×¨ ×–××Ÿ", callback_data="game_time_challenge")
            ],
            [
                InlineKeyboardButton("ğŸª ××©×—×§ ×ª×œ×™×™×”", callback_data="game_hangman"),
                InlineKeyboardButton("ğŸ”™ ×—×–×¨×”", callback_data="back_to_menu")
            ]
        ]
        
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.message.edit_text("×‘×—×¨ ××©×—×§:", reply_markup=reply_markup)
        
    # Add more callback handlers for other buttons...

# Helper function for word practice
async def show_next_word(message, context):
    words = context.user_data["current_words"]
    index = context.user_data["current_word_index"]
    
    if index >= len(words):
        # Practice session completed
        await message.edit_text(
            "×›×œ ×”×›×‘×•×“! ×¡×™×™××ª ××ª ××¤×’×© ×”×ª×¨×’×•×œ.\n\n"
            "×¨×•×¦×” ×œ×ª×¨×’×œ ×¢×•×“ ××™×œ×™×?",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("âœ… ×›×Ÿ", callback_data="practice")],
                [InlineKeyboardButton("ğŸ”™ ×—×–×¨×” ×œ×ª×¤×¨×™×˜", callback_data="back_to_menu")]
            ])
        )
        return
    
    current_word = words[index]
    
    # Show word with definition and example
    word_text = f"""
    ğŸ“ ××™×œ×”: {current_word['english']}
    ğŸ”¤ ×ª×¨×’×•×: {current_word['hebrew']}
    ğŸ“‹ ×—×œ×§ ×“×™×‘×•×¨: {current_word['part_of_speech']}
    
    ğŸ“š ×“×•×’×××•×ª:
    - {current_word['examples'][0]}
    """
    
    if len(current_word['examples']) > 1:
        word_text += f"- {current_word['examples'][1]}\n"
    
    if current_word.get('synonyms'):
        word_text += f"\nğŸ”„ ××™×œ×™× × ×¨×“×¤×•×ª: {', '.join(current_word['synonyms'])}"
    
    # Add buttons for user response
    keyboard = [
        [
            InlineKeyboardButton("âœ… ×–×›×¨×ª×™", callback_data="word_remembered"),
            InlineKeyboardButton("âŒ ×œ× ×–×›×¨×ª×™", callback_data="word_forgot")
        ],
        [
            InlineKeyboardButton("â­ï¸ ×”××™×œ×” ×”×‘××”", callback_data="next_word")
        ]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    await message.edit_text(word_text, reply_markup=reply_markup)

# Main function
def main():
    # Create application
    application = ApplicationBuilder().token(API_TOKEN).build()
    
    # Add command handlers
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("profile", profile_command))
    # Add more command handlers...
    
    # Add callback query handler
    application.add_handler(CallbackQueryHandler(button_callback))
    
    # Add message handler for chat
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, message_handler))
    
    # Start the Bot
    application.run_polling()

# Message handler for regular messages
async def message_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    message_text = update.message.text
    state = context.user_data.get("state", UserState.IDLE)
    
    if state == UserState.REGISTERING:
        # Process registration steps
        registration_step = context.user_data.get("registration_step", 1)
        
        if registration_step == 1:
            # Process level selection
            level_map = {"××ª×—×™×œ": 1, "×‘×™× ×•× ×™": 2, "××ª×§×“×": 3}
            selected_level = level_map.get(message_text.strip().lower(), 1)
            
            user_data = await get_user_data(user.id)
            user_data["current_level"] = selected_level
            await save_user_data(user_data)
            
            context.user_data["registration_step"] = 2
            await update.message.reply_text(
                "××¦×•×™×Ÿ! ×‘××™×œ×• × ×•×©××™× ××ª×” ××ª×¢× ×™×™×Ÿ? "\
                "(×œ×“×•×’××”: ×¢×¡×§×™×, ×˜×›× ×•×œ×•×’×™×”, × ×¡×™×¢×•×ª, ×¡×¤×¨×•×ª, ××“×¢...)\n"\
                "×× × ×¨×©×•× ×¢×“ 5 × ×•×©××™×, ××•×¤×¨×“×™× ×‘×¤×¡×™×§×™×."
            )
        
        elif registration_step == 2:
            # Process topics
            topics = [topic.strip() for topic in message_text.split(",")]
            topics = topics[:5]  # Limit to 5 topics
            
            user_data = await get_user_data(user.id)
            user_data["learning_preferences"]["preferred_topics"] = topics
            await save_user_data(user_data)
            
            context.user_data["registration_step"] = 3
            await update.message.reply_text(
                "××¢×•×œ×”! ×›××” ××™×œ×™× ×—×“×©×•×ª ×”×™×™×ª ×¨×•×¦×” ×œ×œ××•×“ ×‘×›×œ ×™×•×? (××¡×¤×¨ ×‘×™×Ÿ 5-20)"
            )
        
        elif registration_step == 3:
            # Process daily goal
            try:
                goal = int(message_text.strip())
                goal = max(5, min(20, goal))  # Ensure between 5-20
            except ValueError:
                goal = 10  # Default if not a number
            
            user_data = await get_user_data(user.id)
            user_data["learning_preferences"]["daily_goal"] = goal
            await save_user_data(user_data)
            
            # Finish registration
            context.user_data["state"] = UserState.IDLE
            del context.user_data["registration_step"]
            
            keyboard = [
                [
                    InlineKeyboardButton("ğŸ”¤ ×ª×¨×’×•×œ ××™×œ×™×", callback_data="practice"),
                    InlineKeyboardButton("ğŸ® ××©×—×§×™×", callback_data="games")
                ],
                [
                    InlineKeyboardButton("ğŸ“š ×¡×™×¤×•×¨×™×", callback_data="stories"),
                    InlineKeyboardButton("âœï¸ ××ª×’×¨×™ ×›×ª×™×‘×”", callback_data="writing")
                ]
            ]
            
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            await update.message.reply_text(
                f"××¦×•×™×Ÿ! ×”×”×¨×©××” ×”×•×©×œ××”. ×™×¢×“ ×™×•××™: {goal} ××™×œ×™× ×—×“×©×•×ª.\n\n"\
                "×”×‘×•×˜ ××•×›×Ÿ ×œ×¢×–×•×¨ ×œ×š ×œ×œ××•×“ ×× ×’×œ×™×ª. ××” ×ª×¨×¦×” ×œ×¢×©×•×ª ×¢×›×©×™×•?",
                reply_markup=reply_markup
            )
    
    elif state == UserState.WRITING:
        # Process writing challenge submission
        writing_prompt = context.user_data.get("writing_prompt")
        required_words = context.user_data.get("required_words", [])
        
        # Use Gemini API to analyze the text
        prompt = f"""
        ×”×˜×§×¡×˜ ×”×‘× × ×›×ª×‘ ×¢×œ ×™×“×™ ×œ×•××“ ×× ×’×œ×™×ª:
        {message_text}
        
        × ×ª×— ××ª ×”×˜×§×¡×˜ ×•×¡×¤×§ ××©×•×‘ ×¢×œ:
        1. ×©×™××•×© × ×›×•×Ÿ ×‘××™×œ×™×: {', '.join(required_words)}
        2. ×“×™×•×§ ×“×§×“×•×§×™ (×¡××Ÿ ×˜×¢×•×™×•×ª ×•×ª×§×Ÿ ××•×ª×Ÿ)
        3. ××‘× ×” ××©×¤×˜×™× ×•×¤×¡×§××•×ª
        4. ×”×¦×¢×•×ª ×¡×¤×¦×™×¤×™×•×ª ×œ×©×™×¤×•×¨ (3-5 ×”×¦×¢×•×ª)
        5. ×ª×Ÿ ×¦×™×•×Ÿ ×›×œ×œ×™ (1-10) ×•×”×¡×‘×¨ ×§×¦×¨
        
        ×”×ª×©×•×‘×” ×¦×¨×™×›×” ×œ×”×™×•×ª ×× ×•×¡×—×ª ×‘×¦×•×¨×” ××¢×•×“×“×ª ×•×‘×•× ×”.
        """
        
        response = model.generate_content(prompt)
        feedback = response.text
        
        # Save the writing submission
        user_data = await get_user_data(user.id)
        if "writings" not in user_data:
            user_data["writings"] = []
            
        user_data["writings"].append({
            "date": datetime.now().strftime("%Y-%m-%d"),
            "prompt": writing_prompt,
            "text": message_text,
            "feedback": feedback
        })
        
        # Update practice time
        user_data["progress"]["total_practice_time"] += 10  # Estimate 10 minutes
        await save_user_data(user_data)
        
        # Send feedback
        await update.message.reply_text(
            f"×ª×•×“×” ×¢×œ ×”×˜×§×¡×˜ ×©×œ×š! ×”× ×” ×”××©×•×‘:\n\n{feedback}\n\n"\
            "×¨×•×¦×” ×œ× ×¡×•×ª ××ª×’×¨ ×›×ª×™×‘×” × ×•×¡×£?",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("âœ… ×›×Ÿ", callback_data="writing")],
                [InlineKeyboardButton("ğŸ”™ ×—×–×¨×” ×œ×ª×¤×¨×™×˜", callback_data="back_to_menu")]
            ])
        )
        
        # Reset state
        context.user_data["state"] = UserState.IDLE
        if "writing_prompt" in context.user_data:
            del context.user_data["writing_prompt"]
        if "required_words" in context.user_data:
            del context.user_data["required_words"]
    
    elif state == UserState.CHATTING:
        # Handle interactive chat
        user_data = await get_user_data(user.id)
        level = user_data.get("current_level", 1)
        
        # Get appropriate words to include in the response
        recent_words = await get_random_words(3, difficulty=level)
        words_to_include = [word["english"] for word in recent_words]
        
        # Get chat history
        chat_history = context.user_data.get("chat_history", [])
        
        # Prepare prompt for Gemini
        prompt = f"""
        × ×”×œ ×©×™×—×” ×‘× ×•×©× ×›×œ×œ×™ ×¢× ×œ×•××“ ×× ×’×œ×™×ª ×‘×¨××” {level} (1=××ª×—×™×œ, 2=×‘×™× ×•× ×™, 3=××ª×§×“×).
        ×›×œ×•×œ ××ª ×”××™×œ×™× ×”×‘××•×ª ×‘×ª×©×•×‘×•×ª×™×š ×‘×¦×•×¨×” ×˜×‘×¢×™×ª: {', '.join(words_to_include)}.
        ×•×“× ×©×”×ª×©×•×‘×” ×©×œ×š ×ª×”×™×” ×‘×¨××” ×”××ª××™××” ×œ×œ×•××“.
        ×× ×”××©×ª××© ×¢×•×©×” ×˜×¢×•×™×•×ª, ×ª×§×Ÿ ××•×ª×Ÿ ×‘×¢×“×™× ×•×ª.
        ×©××œ ×©××œ×•×ª ×©×™×¢×•×“×“×• ×”××©×š ×©×™×—×”.
        
        ×”×§×©×¨ ×”×©×™×—×” ×”×§×•×“×:
        {' '.join(chat_history[-5:]) if chat_history else '××™×Ÿ'}
        
        ×”×”×•×“×¢×” ×”××—×¨×•× ×” ×©×œ ×”××©×ª××©: {message_text}
        """
        
        response = model.generate_content(prompt)
        bot_reply = response.text
        
        # Update chat history
        chat_history.append(f"User: {message_text}")
        chat_history.append(f"Bot: {bot_reply}")
        context.user_data["chat_history"] = chat_history
        
        # Update user statistics
        user_data["progress"]["total_practice_time"] += 2  # Estimate 2 minutes per exchange
        
        # Record newly used words
        for word in words_to_include:
            word_entry = words_collection.find_one({"english": word})
            if word_entry:
                word_id = str(word_entry["_id"])
                word_learning_entry = next((w for w in user_data["progress"]["words_learning"] if w["word_id"] == word_id), None)
                
                if not word_learning_entry:
                    user_data["progress"]["words_learning"].append({
                        "word_id": word_id,
                        "status": "new", 
                        "repetitions": 1,
                        "next_review": (datetime.now() + timedelta(hours=4)).strftime("%Y-%m-%d %H:%M:%S"),
                        "success_rate": 0.0
                    })
                else:
                    word_learning_entry["repetitions"] += 1
        
        await save_user_data(user_data)
        
        # Send response with option to continue or exit chat
        keyboard = [
            [InlineKeyboardButton("ğŸ”š ×¡×™×™× ×¦'××˜", callback_data="end_chat")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(bot_reply, reply_markup=reply_markup)
    
    # Handle other states...

if __name__ == "__main__":
    main()
```

## 10. ×©×™×§×•×œ×™ ××‘×˜×—×” ×•×¤×¨×˜×™×•×ª

### 10.1 ××‘×˜×—×ª × ×ª×•× ×™×
1. ××—×¡×•×Ÿ ×××•×‘×˜×— ×©×œ API tokens (×©×™××•×© ×‘-environment variables)
2. ×”×¦×¤× ×ª × ×ª×•× ×™ ××©×ª××©×™× ×¨×’×™×©×™×
3. ×’×™×‘×•×™ ×ª×§×•×¤×ª×™ ×©×œ ××¡×“ ×”× ×ª×•× ×™×
4. ×”×’×‘×œ×ª ×”×¨×©××•×ª ×’×™×©×” ×œ××¡×“ ×”× ×ª×•× ×™×

### 10.2 ×¤×¨×˜×™×•×ª ××©×ª××©×™×
1. ××™×¡×•×£ ××™× ×™××œ×™ ×©×œ ××™×“×¢ ××™×©×™
2. ××“×™× ×™×•×ª ×¤×¨×˜×™×•×ª ×‘×¨×•×¨×” ×”××•×¦×’×ª ×œ××©×ª××©×™×
3. ××¤×©×¨×•×ª ×œ××—×™×§×ª ×—×©×‘×•×Ÿ ×•×›×œ ×”××™×“×¢ ×”×§×©×•×¨
4. ×”×’×‘×œ×ª ×”×©×™××•×© ×‘××™×“×¢ ××©×ª××©×™× ×¨×§ ×œ××˜×¨×•×ª ×©×™×¤×•×¨ ×”×‘×•×˜

### 10.3 ×× ×™×¢×ª ×©×™××•×© ×œ×¨×¢×”
1. × ×™×˜×•×¨ ×•×–×™×”×•×™ ×“×¤×•×¡×™ ×©×™××•×© ×—×¨×™×’×™×
2. ×”×’×‘×œ×ª ××¡×¤×¨ ×”×‘×§×©×•×ª ×œ×™×•× ×œ×× ×™×¢×ª ×©×™××•×© ×œ×¨×¢×” ×‘××©××‘×™×
3. ×¤×™×œ×˜×¨×™× ×œ×ª×•×›×Ÿ ×œ× ×¨××•×™ ×‘××©×•×‘ ××©×ª××©×™×
4. ××¢×¨×›×ª ×“×™×•×•×— ×¢×œ ×ª×§×œ×•×ª ×•×‘×¢×™×•×ª

## 11. ××ª×’×¨×™× ×¤×•×˜× ×¦×™××œ×™×™× ×•×¤×ª×¨×•× ×•×ª

### 11.1 ×™×›×•×œ×•×ª ××•×’×‘×œ×•×ª ×©×œ Gemini API
- **××ª×’×¨**: API ×¢×œ×•×œ ×œ×”×™×•×ª ××•×’×‘×œ ×‘××™× ×˜×¨××§×˜×™×‘×™×•×ª ××• ×‘×”×‘× ×ª ×”×§×©×¨
- **×¤×ª×¨×•×Ÿ**: ×©××™×¨×ª ×”×§×©×¨ ×©×™×—×” ×•×”×¢×‘×¨×ª×• ×¢× ×›×œ ×‘×§×©×”; ×™×¦×™×¨×ª ×¤×¨×•××¤×˜×™× ××¤×•×¨×˜×™× ×•××“×•×™×§×™×

### 11.2 ×“×™×•×§ ×‘×ª×™×§×•×Ÿ ×˜×¢×•×™×•×ª
- **××ª×’×¨**: ×”×‘×•×˜ ×¢×œ×•×œ ×œ×˜×¢×•×ª ×‘×–×™×”×•×™ ××• ×ª×™×§×•×Ÿ ×©×’×™××•×ª
- **×¤×ª×¨×•×Ÿ**: ×©×™×œ×•×‘ ××¢×¨×›×•×ª ×‘×“×™×§×ª ××™×•×ª ×•×“×§×“×•×§ ×™×™×¢×•×“×™×•×ª ×‘× ×•×¡×£ ×œ-LLM

### 11.3 ×¢×•××¡ ××©××‘×™×
- **××ª×’×¨**: ×©×™××•×© ×¨×‘ ×‘-API ×¢×œ×•×œ ×œ×™×¦×•×¨ ×¢×œ×•×™×•×ª ×’×‘×•×”×•×ª
- **×¤×ª×¨×•×Ÿ**: ××˜××•×Ÿ (caching) ×œ×ª×©×•×‘×•×ª × ×¤×•×¦×•×ª; ××•×¤×˜×™××™×–×¦×™×” ×©×œ ××¡×¤×¨ ×”×‘×§×©×•×ª; ×”×’×‘×œ×ª ×©×™××•×©

### 11.4 ×”×ª××•×“×“×•×ª ×¢× ×¨××•×ª ×©×•× ×•×ª ×©×œ ××©×ª××©×™×
- **××ª×’×¨**: ××©×ª××©×™× ×‘×¨××•×ª ×©×•× ×•×ª ×××•×“
- **×¤×ª×¨×•×Ÿ**: ××¢×¨×›×ª ×“×™× ××™×ª ×œ×”×ª×××ª ×¨××ª ×§×•×©×™; ××‘×—× ×™ ×¨××” ×ª×§×•×¤×ª×™×™×

## 12. ××“×“×™ ×”×¦×œ×—×”

### 12.1 ××“×“×™ ×©×™××•×©
1. ××¡×¤×¨ ××©×ª××©×™× ×¤×¢×™×œ×™× ×™×•××™/×©×‘×•×¢×™/×—×•×“×©×™
2. ×©×™××•×¨ ××©×ª××©×™× ×œ××•×¨×š ×–××Ÿ
3. ××•×¨×š ×××•×¦×¢ ×©×œ ×¡×©×Ÿ ×œ××™×“×”
4. ××¡×¤×¨ ×¤×¢×™×œ×•×™×•×ª ×©×”×•×©×œ××•

### 12.2 ××“×“×™ ×œ××™×“×”
1. ××¡×¤×¨ ××™×œ×™× ×©× ×œ××“×• ×œ×¤×™ ××©×ª××©
2. ×©×™×¤×•×¨ ×‘××—×•×–×™ ×”×¦×œ×—×” ×œ××•×¨×š ×–××Ÿ
3. ×¢×§×‘×™×•×ª ×”×œ××™×“×” (×¡×˜×¨×™×§×™×)
4. ×©×™×¤×•×¨ ×‘××‘×—× ×™ ×¨××” ×ª×§×•×¤×ª×™×™×

### 12.3 ××“×“×™ ×‘×™×¦×•×¢×™ ××¢×¨×›×ª
1. ×–××Ÿ ×ª×’×•×‘×” ×××•×¦×¢
2. ××—×•×– ×©×’×™××•×ª ×•×ª×§×œ×•×ª
3. ×™×¦×™×‘×•×ª ×”××¢×¨×›×ª ×ª×—×ª ×¢×•××¡
4. ×¦×¨×™×›×ª ××©××‘×™× ×•×¢×œ×•×™×•×ª ×ª×¤×¢×•×œ

## 13. ×ª×—×–×•×§×” ×•×©×“×¨×•×’×™× ×¢×ª×™×“×™×™×

### 13.1 ×ª×—×–×•×§×” ×©×•×˜×¤×ª
1. × ×™×˜×•×¨ ×‘×™×¦×•×¢×™× ×•×ª×™×§×•×Ÿ ×‘××’×™×
2. ×¢×“×›×•× ×™ ××‘×˜×—×” ×ª×§×•×¤×ª×™×™×
3. ×’×™×‘×•×™ ××¡×“ × ×ª×•× ×™×
4. × ×™×ª×•×— × ×ª×•× ×™ ×©×™××•×© ×œ×©×™×¤×•×¨ ×—×•×•×™×™×ª ×”××©×ª××©

### 13.2 ×©×“×¨×•×’×™× ×¤×•×˜× ×¦×™××œ×™×™×
1. **×”×•×¡×¤×ª ××¤×™×•× ×™ ×©××¢** - ×ª××™×›×” ×‘×§×œ×˜/×¤×œ×˜ ×§×•×œ×™ ×œ×©×™×¤×•×¨ ××™×•×× ×•×™×•×ª ×”×’×™×™×” ×•×”××–× ×”
2. **×ª××™×›×” ×‘×¤×œ×˜×¤×•×¨××•×ª × ×•×¡×¤×•×ª** - WhatsApp, Discord, ××• ××¤×œ×™×§×¦×™×” ×¢×¦×××™×ª
3. **×©×™×œ×•×‘ ×¢× ×—×•××¨×™ ×œ××™×“×” ×—×™×¦×•× ×™×™×** - ×¡×¤×¨×™×, ×¡×¨×˜×•× ×™×, ×¤×•×“×§××¡×˜×™×
4. **×™×›×•×œ×•×ª AI ××ª×§×“××•×ª ×™×•×ª×¨** - ×”×˜××¢×ª ××•×“×œ×™× ××ª×§×“××™× ×™×•×ª×¨ ×›×©×™×”×™×• ×–××™× ×™×
5. **×œ××™×“×” ×—×‘×¨×ª×™×ª** - ××¤×©×¨×•×ª ×œ×œ××•×“ ×¢× ×—×‘×¨×™× ×•×œ×”×ª×—×¨×•×ª ×‘×™× ×™×”×

## 14. ×¡×™×›×•×

×”×‘×•×˜ ×”××ª×•×›× ×Ÿ ×™×”×™×” ×›×œ×™ ×¢×•×¦××ª×™ ×œ×œ×™××•×“ ×× ×’×œ×™×ª, ×”××©×œ×‘ ××ª ×”×™×›×•×œ×•×ª ×”××ª×§×“××•×ª ×©×œ Gemini API ×¢× ×©×™×˜×•×ª ×œ×™××•×“ ××‘×•×¡×¡×•×ª ××—×§×¨. ×”×•× ××¦×™×¢ ××’×•×•×Ÿ ×¨×—×‘ ×©×œ ×¤×¢×™×œ×•×™×•×ª ××™× ×˜×¨××§×˜×™×‘×™×•×ª, ×”×ª×××” ××™×©×™×ª, ×•××¢×§×‘ ××—×¨ ×”×ª×§×“××•×ª, ×©×™××¤×©×¨×• ×œ××©×ª××©×™× ×œ×œ××•×“ ×× ×’×œ×™×ª ×‘×¦×•×¨×” ×™×¢×™×œ×” ×•××”× ×”.

×”××™×¤×™×•×Ÿ ×”××¤×•×¨×˜ ×©×”×•×¦×’ ×›×•×œ×œ ××ª ×›×œ ×”×¨×›×™×‘×™× ×”×“×¨×•×©×™× ×œ×¤×™×ª×•×— ×”×‘×•×˜, ×”×—×œ ××¡×™×¤×•×¨×™ ×”××©×ª××© ×•×¢×“ ×œ×§×•×“ ×œ×“×•×’××”, ×•××“×“×™ ×”×¦×œ×—×”. ×”×•× ××ª×™×™×—×¡ ×’× ×œ××ª×’×¨×™× ×¤×•×˜× ×¦×™××œ×™×™× ×•××¦×™×¢ ×¤×ª×¨×•× ×•×ª ××¤×©×¨×™×™×.

×”×ª×•×›× ×™×ª ×”××“×•×¨×’×ª ×œ×¤×™×ª×•×— ×××¤×©×¨×ª ×™×™×©×•× ×”×“×¨×’×ª×™, ×›××©×¨ × ×™×ª×Ÿ ×œ×”×ª×—×™×œ ×¢× ×’×¨×¡×” ×‘×¡×™×¡×™×ª ×•×œ×”×•×¡×™×£ ×ª×›×•× ×•×ª ××ª×§×“××•×ª ×œ××•×¨×š ×–××Ÿ, ×‘×”×ª×× ×œ××©×•×‘ ×”××©×ª××©×™× ×•×¦×¨×›×™ ×”××¢×¨×›×ª.